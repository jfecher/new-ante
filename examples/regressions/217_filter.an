effect Emit a with
    emit: a -> Unit

iota (n: U32) = loop (i = 0) ->
    if i < n then
        emit i
        recur (i + 1)

// Removing the `can` here used to panic
filter (stream: Unit -> Unit) (f: a -> Bool pure) =
    handle 
        stream ()
    | emit x ->
        if f x then
            emit x
        resume ()

for (stream: Unit -> Unit can Emit a) (f: a -> Unit pure) =
    handle 
        stream ()
    | emit x ->
        f x
        resume ()

zero_to_nine () =
    iota 10

filtered () =
    filter zero_to_nine (fn x -> x % 2 == 0)

for filtered print

// args: --delete-binary
// expected stdout:
// // id = c1m59_9
// effect Emit_c1m59_9 a_1 with
//     emit_2: a_1
// 
// // id = c1m59_99
// iota_c1m59_99 (n_1: U32) = (error)
// 
// // id = c1m59_37
// zero_to_nine_c1m59_37 () =
//     iota_c1m59_99 10
// 
// // id = c1m59_19
// filtered_c1m59_19 () =
//     filter_? zero_to_nine_c1m59_37 (error)

// expected stderr:
// examples/regressions/217_filter.an:2:12	error: Expected an unindent but found `->`
//     emit: a -> Unit
// 
// examples/regressions/217_filter.an:4:16	error: Expected an expression but found `loop`
// iota (n: U32) = loop (i = 0) ->
// 
// examples/regressions/217_filter.an:10:7	error: Expected `=` to begin the function body but found `(`
// filter (stream: Unit -> Unit) (f: a -> Bool pure) =
// 
// examples/regressions/217_filter.an:18:4	error: Expected `=` to begin the function body but found `(`
// for (stream: Unit -> Unit can Emit a) (f: a -> Unit pure) =
// 
// examples/regressions/217_filter.an:29:4	error: `filter` is not defined, was it a typo?
//     filter zero_to_nine (fn x -> x % 2 == 0)
// 
// examples/regressions/217_filter.an:29:25	error: Expected a parameter but found `fn`
//     filter zero_to_nine (fn x -> x % 2 == 0)
// 
// examples/regressions/217_filter.an:29:25	error: Expected an expression but found `fn`
//     filter zero_to_nine (fn x -> x % 2 == 0)
// 
// examples/regressions/217_filter.an:31:4	error: Expected `=` to begin the function body but found `filtered`
// for filtered print

